-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------FREES/WAN QUICK START ON FIREWALLING------------ THIS FIREWALLING INFORMATION-SUPPLEMENTS OUR--------------------------------------- QUICKSTART GUIDE.----------- IT INCLUDES TIPS FOR FIREWALLING:-------------------------------------------- A STANDALONE SYSTEM WITH--INITIATOR-ONLY OPPORTUNISM---------------------------------------------- INCOMING OPPORTUNISTIC CONNECTIONS------------------------------------------- AN OPPORTUNISTIC GATEWAY------------------ AND A LIST OF HELPFUL--------------------- RESOURCES----.-------------------------------------- FIREWALLING A STANDALONE SYSTEM------------ FIREWALL RULES ON A STANDALONE SYSTEM DOING IPSEC CAN BE VERY SIMPLE.------- THE FIRST STEP IS TO ALLOW IPSEC PACKETS (IKE ON UDP PORT 500 PLUS- ESP, PROTOCOL 50) IN AND OUT OF YOUR GATEWAY. A SCRIPT TO SET UP- IPTABLES(8) RULES FOR THIS IS:--------- # EDIT THIS LINE TO MATCH THE INTERFACE YOU-USE AS DEFAULT ROUTE---PPP0 IS CORRECT FOR MANY MODEM, DSL OR CABLE CONNECTIONS-# BUT PERHAPS NOT FOR YOU-WORLD=PPP-0# # ALLOW IPSEC--## IKE NEGOTIATIONS-IPTABLES -A INPUT- -P UDP -I $WORLD --SPORT 500 --DPORT 500 -J ACCEPT-IPTABLES -A OUTPUT -P UDP -O $WORLD --SPORT 500 --DPORT5 00 -J ACCEPT-# ESP ENCRYPTION AND AUTHENTICATION-IPTABLES -A INPUT- -P 50 -I $WORLD -J ACCEPT-IPTABLES -A OUTPUT -P 50 -O $WORLD -J ACCEPT--------- OPTIONALLY, YOU COULD RESTRICT THIS, ALLOWING THESE PACKETS ONLY TO- AND FROM A LIST OF KNOWN GATEWAYS.------- A SECOND FIREWALLING STEP -- ACCESS CONTROLS BUILT INTO THE IPSEC- PROTOCOLS -- IS AUTOMATICALLY APPLIED:------------------------------------------- PLUTO---- -- THE FREES/WAN KEYING- DAEMON -- DEALS WITH THE IKE PACKETS.--------- PLUTO AUTHENTICATES ITS PARTNERS DURING THE IKE NEGOTIATION, AND- DROPS NEGOTIATION IF AUTHENTICATION FAILS.--------------------------------------- KLIPS---- -- THE FREES/WAN KERNEL- COMPONENT -- HANDLES THE ESP PACKETS.------------------- KLIPS DROPS OUTGOING PACKETS--------- IF THEY ARE ROUTED TO IPSEC, BUT NO TUNNEL HAS BEEN NEGOTIATED FOR- THEM--------- KLIPS DROPS INCOMING UNENCRYPTED PACKETS--------- IF SOURCE AND DESTINATION ADDRESSES MATCH A TUNNEL; THE PACKETS- SHOULD HAVE BEEN ENCRYPTED--------- KLIPS DROPS INCOMING ENCRYPTED PACKETS--------- IF SOURCE AND DESTINATION ADDRESS DO NOT MATCH THE NEGOTIATED- PARAMETERS OF THE TUNNEL THAT DELIVERS THEM--------- IF PACKET-LEVEL AUTHENTICATION FAILS-------------------------- THESE ERRORS ARE LOGGED. SEE OUR------------------------ TROUBLESHOOTING---- DOCUMENT FOR DETAILS.------- AS AN OPTIONAL THIRD STEP, YOU MAY WISH TO FILTER PACKETS EMERGING- FROM YOUR OPPORTUNISTIC TUNNELS. THESE PACKETS ARRIVE ON AN INTERFACE- SUCH AS----- IPSEC------0, RATHER THAN----- ETH------0,----- PPP-------0 OR WHATEVER. FOR EXAMPLE, IN-AN IPTABLES(8) RULE SET, YOU WOULD USE:------------------ -I IPSEC---------------+ TO SPECIFY PACKETS ARRIVING ON ANY IPSEC DEVICE-------------- -O IPSEC---------------+ TO SPECIFY PACKETS LEAVING VIA ANY IPSEC DEVICE-------------- IN THIS WAY, YOU CAN APPLY WHATEVER-ADDITIONAL-FILTERING YOU LIKE TO- THESE PACKETS.------- THE PACKETS EMERGING ON----- IPSEC------0 ARE LIKELY TO BE THINGS- THAT A CLIENT APPLICATION ON YOUR MACHINE REQUESTED: WEB PAGES, E-MAIL-, FILE TRANSFERS AND SO ON. HOWEVER, ANY TIME YOU INITIATE AN- OPPORTUNISTIC CONNECTION, YOU OPEN A TWO-WAY CONNECTION TO ANOTHER- MACHINE (OR NETWORK). IT IS CONCEIVABLE THAT A BAD GUY THERE COULD TAKE- ADVANTAGE OF YOUR LINK.------- FOR MORE INFORMATION, READ THE NEXT SECTION.---------------------------------------- FIREWALLING INCOMING OPPORTUNISTIC- CONNECTIONS------------ THE BASIC FIREWALLING FOR IPSEC DOES NOT CHANGE WHEN YOU SUPPORT- INCOMING CONNECTIONS AS WELL AS CONNECTIONS YOU INITIATE. YOU MUST- STILL ALLOW IKE (UDP PORT 500) AND ESP (PROTOCOL 50) PACKETS TO AND- FROM YOUR MACHINE, AS IN THE RULES GIVEN-------------------------------- ABOVE----.------- HOWEVER, THERE IS AN ADDITIONAL SECURITY CONCERN WHEN YOU ALLOW- INCOMING OPPORTUNISTIC CONNECTIONS. INCOMING OPPORTUNISTIC PACKETS- ENTER YOUR MACHINE VIA AN IPSEC TUNNEL. THAT IS, THEY ALL APPEAR AS ESP- (PROTOCOL 50) PACKETS, CONCEALING WHATEVER PORT AND PROTOCOL- CHARACTERISTICS THE PACKET WITHIN THE TUNNEL HAS. CONTAINED IN THE- TUNNEL AS THEY PASS THROUGH----- PPP------0 OR----- ETH------0, THESE- PACKETS CAN BYPASS YOUR USUAL FIREWALL RULES ON THESE INTERFACES.------- CONSEQUENTLY, YOU WILL WANT TO FIREWALL YOUR----- IPSEC------- INTERFACES THE WAY YOU WOULD ANY PUBLICLY ACCESSIBLE INTERFACE.------- A SIMPLE WAY TO DO THIS IS TO CREATE ONE IPTABLES(8) TABLE WITH ALL- YOUR FILTERING RULES FOR INCOMING PACKETS, AND APPLY THE ENTIRE TABLE- TO ALL PUBLIC INTERFACES, INCLUDING----- IPSEC------ INTERFACES.------------------------------------ FIREWALLING FOR OPPORTUNISTIC GATEWAYS------------- ON A GATEWAY, THE IPSEC-RELATED FIREWALL RULES APPLIED FOR INPUT AND- OUTPUT ON THE INTERNET SIDE ARE EXACTLY AS SHOWN-------------------------------- ABOVE----. A GATEWAY EXCHANGES EXACTLY THE SAME THINGS -- UDP- 500 PACKETS AND IPSEC PACKETS -- WITH OTHER GATEWAYS THAT A STANDALONE- SYSTEM DOES, SO IT CAN USE EXACTLY THE SAME FIREWALL RULES AS A- STANDALONE SYSTEM WOULD.------- HOWEVER, ON A GATEWAY THERE ARE ADDITIONAL THINGS TO DO:------------- YOU HAVE OTHER INTERFACES AND NEED RULES FOR THEM--------- PACKETS EMERGING FROM IPSEC PROCESSING MUST BE CORRECTLY FORWARDED-------------- YOU NEED ADDITIONAL RULES TO HANDLE THESE THINGS. FOR EXAMPLE, ADDING- SOME RULES TO THE SET SHOWN ABOVE WE GET:--------- # EDIT THIS LINE TO MATCH THE INTERFACE YOU USE AS DEFAULT ROUTE-# PPP0 IS CORRECT FOR MANY MODEM, DSL OR CABLE CONNECTIONS-# BUT PERHAPS NOT FOR YOU-WORLD=PPP-0# # EDIT THESE LINES TO DESCRIBE YOUR INTERNAL SUBNET AND INTERFACE-LOCALNET=42.2 .42.-0/24INTERNAL=ETH--1## ALLOW IPSEC--## IKE NEGOTIATIONS-IPTABLES -A INPUT- -P UDP -I $WORLD --SPORT 500 --DPORT 500 -J ACCEPT-IPTABLES -A OUTPUT -P UDP -O $WORLD --SPORT 500 --DPORT 500 -J ACCEPT-# ESP ENCRYPTION AND AUTHENTICATION-IPTABLES- A INPUT- -P 50 -I $WORLD -J ACCEPT-IPTABLES -A OUTPUT -P 50 -O $WORLD -J ACCEPT-# # PACKET FORWARDING FOR AN IPSEC GATEWAY-# SIMPLEST POSSIBLE RULES-$ FORWARD EVERYTHING, WITH NO ATTEMPT TO FILTER--## HANDLE PACKETS EMERGING FROM IPSEC-# IPSEC+ MEANS ANY OF IPSEC0, IPSEC1, ...-IPTABLES -A FORWARD -D $LOCALNET -I IPSEC+ -J ACCEPT-# SIMPLE RULE FOR OUTBOUND PACKETS-# LET LOCAL NET SEND ANYTHING-# IPSEC WILL ENCRYPT SOME OF IT-IPTABLES -A FORWARD -S $LOCALNET -I $INTERNAL -J ACCEPT---------- ON A PRODUCTION GATEWAY, YOU WOULD NO DOUBT NEED TIGHTER RULES THAN- THE ABOVE.------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------